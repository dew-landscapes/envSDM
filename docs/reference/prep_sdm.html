<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Prepare for running an SDM — prep_sdm • envSDM</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prepare for running an SDM — prep_sdm"><meta name="description" content="The background sampling includes code based on a
Geographic Information Systems stack exchange
answer
by user Spacedman."><meta property="og:description" content="The background sampling includes code based on a
Geographic Information Systems stack exchange
answer
by user Spacedman."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">envSDM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/acanthiza/envSDM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Prepare for running an SDM</h1>
      <small class="dont-index">Source: <a href="https://github.com/acanthiza/envSDM/blob/HEAD/R/prep_sdm.R" class="external-link"><code>R/prep_sdm.R</code></a></small>
      <div class="d-none name"><code>prep_sdm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The background sampling includes code based on a
<a href="https://gis.stackexchange.com/" class="external-link">Geographic Information Systems stack exchange</a>
<a href="https://gis.stackexchange.com/a/224347" class="external-link">answer</a>
by user <a href="https://gis.stackexchange.com/users/865/spacedman" class="external-link">Spacedman</a>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">prep_sdm</span><span class="op">(</span></span>
<span>  this_taxa <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  out_dir <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_val <span class="op">=</span> <span class="st">"path"</span>,</span>
<span>  <span class="va">presence</span>,</span>
<span>  pres_crs <span class="op">=</span> <span class="fl">4326</span>,</span>
<span>  pres_x <span class="op">=</span> <span class="st">"long"</span>,</span>
<span>  pres_y <span class="op">=</span> <span class="st">"lat"</span>,</span>
<span>  pred_limit <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  limit_buffer <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pred_clip <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">predictors</span>,</span>
<span>  is_env_pred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  max_cells_in_memory <span class="op">=</span> <span class="fl">3e+07</span>,</span>
<span>  terra_options <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  subset_pred_thresh <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  cat_preds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  num_bg <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  prop_abs <span class="op">=</span> <span class="st">"abs"</span>,</span>
<span>  many_p_prop <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  folds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  spatial_folds <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  min_fold_n <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  stretch_value <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  dens_res <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  save_pngs <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  reduce_env <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  thresh <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>  do_gc <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  force_new <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-this-taxa">this_taxa<a class="anchor" aria-label="anchor" href="#arg-this-taxa"></a></dt>
<dd><p>Character. Name of taxa. Only used to print some messages.
Ignored if NULL</p></dd>


<dt id="arg-out-dir">out_dir<a class="anchor" aria-label="anchor" href="#arg-out-dir"></a></dt>
<dd><p>FALSE or character. If FALSE the result of prep_sdm will be
saved to a temporary folder. If character, a file 'prep.rds' will be created
at the path defined by out_dir.</p></dd>


<dt id="arg-return-val">return_val<a class="anchor" aria-label="anchor" href="#arg-return-val"></a></dt>
<dd><p>Character: "object" or "path". Both return a named list. In
the case of "path" the named list is simply list(prep = out_dir). Will be set
to "object" if <code>out_dir</code> is FALSE.</p></dd>


<dt id="arg-presence">presence<a class="anchor" aria-label="anchor" href="#arg-presence"></a></dt>
<dd><p>Dataframe of presences with columns <code>pres_x</code> and <code>pres_y</code>.</p></dd>


<dt id="arg-pres-crs">pres_crs<a class="anchor" aria-label="anchor" href="#arg-pres-crs"></a></dt>
<dd><p>Anything that will return a legitimate crs when passed to the
crs attribute of <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">sf::st_transform()</a></code> or <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">sf::st_as_sf()</a></code>.</p></dd>


<dt id="arg-pres-x-pres-y">pres_x, pres_y<a class="anchor" aria-label="anchor" href="#arg-pres-x-pres-y"></a></dt>
<dd><p>Character. Name of the columns in <code>presence</code> that have
the x and y coordinates</p></dd>


<dt id="arg-pred-limit">pred_limit<a class="anchor" aria-label="anchor" href="#arg-pred-limit"></a></dt>
<dd><p>Limit the background points and predictions?
Can be <code>TRUE</code> (use <code>presence</code> to generate a minimum convex polygon to use as
a limit. Not recommended as the points in <code>presence</code> have usually been
filtered to very accurate spatial reliability and thus may be missing a large
number of legitimate records); <code>FALSE</code> (the full extent of the predictors
will be used); path to existing .parquet to use; or sf object.</p></dd>


<dt id="arg-limit-buffer">limit_buffer<a class="anchor" aria-label="anchor" href="#arg-limit-buffer"></a></dt>
<dd><p>Numeric. Apply this buffer to <code>pred_limit</code>. Only used if
<code>pred_limit</code> is <code>TRUE</code>. Passed to the <code>dist</code> argument of <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">sf::st_buffer()</a></code>.</p></dd>


<dt id="arg-pred-clip">pred_clip<a class="anchor" aria-label="anchor" href="#arg-pred-clip"></a></dt>
<dd><p>sf. Optional sf to clip the pred_limit back to (e.g. to
prevent prediction into ocean).</p></dd>


<dt id="arg-predictors">predictors<a class="anchor" aria-label="anchor" href="#arg-predictors"></a></dt>
<dd><p>Character. Vector of paths to predictor <code>.tif</code> files.</p></dd>


<dt id="arg-is-env-pred">is_env_pred<a class="anchor" aria-label="anchor" href="#arg-is-env-pred"></a></dt>
<dd><p>Logical. Does the naming of the directory and files in
<code>predictors</code> follow the pattern required by <code>envRaster::parse_env_tif()</code>?</p></dd>


<dt id="arg-max-cells-in-memory">max_cells_in_memory<a class="anchor" aria-label="anchor" href="#arg-max-cells-in-memory"></a></dt>
<dd><p>Numeric passed to <code>exactextractr::exactextract()</code>
argument with the same name. <code>prep_sdm()</code> will be quicker with larger values,
but if running on many cores, memory issues are likely. The default of
30000000 is the default for <code>exactextractr::exactextract()</code> at the time of
writing.</p></dd>


<dt id="arg-terra-options">terra_options<a class="anchor" aria-label="anchor" href="#arg-terra-options"></a></dt>
<dd><p>Passed to <code><a href="https://rspatial.github.io/terra/reference/terraOptions.html" class="external-link">terra::terraOptions()</a></code>. e.g. list(memfrac =
0.6)</p></dd>


<dt id="arg-subset-pred-thresh">subset_pred_thresh<a class="anchor" aria-label="anchor" href="#arg-subset-pred-thresh"></a></dt>
<dd><p>Numeric. A threshold value of the extent of
predict_boundary that overlaps the predictors, below which the predictors
will be cropped and masked to the predict boundary before extraction of
values to points. For predict boundaries much smaller than the predictors,
subsetting before extracting data to points will be much (much)
quicker. As the predict boundary approaches the same area covered by the
predictors, subsetting prior to extraction becomes much (much) slower. Also
very expensive in terms of disc space.</p></dd>


<dt id="arg-cat-preds">cat_preds<a class="anchor" aria-label="anchor" href="#arg-cat-preds"></a></dt>
<dd><p>Character. Vector of predictor names that are character.</p></dd>


<dt id="arg-num-bg">num_bg<a class="anchor" aria-label="anchor" href="#arg-num-bg"></a></dt>
<dd><p>Numeric. How many background points?</p></dd>


<dt id="arg-prop-abs">prop_abs<a class="anchor" aria-label="anchor" href="#arg-prop-abs"></a></dt>
<dd><p>Character. Is <code>num_bg</code> a proportion (<code>prop</code>) of the number of
records in <code>presence</code> or an absolute (<code>abs</code>) number?</p></dd>


<dt id="arg-many-p-prop">many_p_prop<a class="anchor" aria-label="anchor" href="#arg-many-p-prop"></a></dt>
<dd><p>Numeric. Ensure the number of background points is at
least <code>many_p_prop * number of presences</code>. e.g. If there are more than 5000
presences and num_bg is set at <code>10000</code> and <code>many_p_prop</code> is <code>2</code>, then num_bg
will be increased to <code>many_p_prop * nrow(presences)</code></p></dd>


<dt id="arg-folds">folds<a class="anchor" aria-label="anchor" href="#arg-folds"></a></dt>
<dd><p>Numeric. How many folds to use in cross validation? Will be
adjusted downwards if number of presences do not support <code>folds * min_fold_n</code></p></dd>


<dt id="arg-spatial-folds">spatial_folds<a class="anchor" aria-label="anchor" href="#arg-spatial-folds"></a></dt>
<dd><p>Logical. Use spatial folds? Even if <code>TRUE</code>, can resort
to non-spatial cv if presences per fold do not meet <code>min_fold_n</code> or there are
not enough presences to support more than one fold.</p></dd>


<dt id="arg-min-fold-n">min_fold_n<a class="anchor" aria-label="anchor" href="#arg-min-fold-n"></a></dt>
<dd><p>Numeric. Sets both minimum number of presences, and,
by default, the minimum number of presences required for a model.</p></dd>


<dt id="arg-stretch-value">stretch_value<a class="anchor" aria-label="anchor" href="#arg-stretch-value"></a></dt>
<dd><p>Numeric. Stretch the density raster to this value.</p></dd>


<dt id="arg-dens-res">dens_res<a class="anchor" aria-label="anchor" href="#arg-dens-res"></a></dt>
<dd><p><code>NULL</code> or numeric. Resolution (in metres) of density raster.
Set to <code>NULL</code> to use the same resolution as the predictors.</p></dd>


<dt id="arg-save-pngs">save_pngs<a class="anchor" aria-label="anchor" href="#arg-save-pngs"></a></dt>
<dd><p>Logical. Save out a .png of the density raster and spatial
blocks</p></dd>


<dt id="arg-reduce-env">reduce_env<a class="anchor" aria-label="anchor" href="#arg-reduce-env"></a></dt>
<dd><p>Logical. If TRUE, highly correlated and low importance
variables will be removed. In the case of highly correlated pairs of
variables, only one is removed.</p></dd>


<dt id="arg-thresh">thresh<a class="anchor" aria-label="anchor" href="#arg-thresh"></a></dt>
<dd><p>Numeric. Threshold used to flag highly correlated and low
importance variables</p></dd>


<dt id="arg-do-gc">do_gc<a class="anchor" aria-label="anchor" href="#arg-do-gc"></a></dt>
<dd><p>Logical. Run <code>base::rm(list = ls)</code> and <code><a href="https://rdrr.io/r/base/gc.html" class="external-link">base::gc()</a></code> at end of
function? Useful when running SDMs for many, many taxa, especially if done in
parallel.</p></dd>


<dt id="arg-force-new">force_new<a class="anchor" aria-label="anchor" href="#arg-force-new"></a></dt>
<dd><p>Logical. If outputs already exist, should they be remade?</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If <code>return_val</code> is "object" a named list. If <code>return_val</code> is "path"
a named list <code>list(prep = out_dir)</code>. If <code>out_dir</code> is a valid path, the 'full
result' (irrespective of <code>return_val</code>) is also saved to
<code>fs::path(out_dir, "prep.rds")</code>. The 'full result' is a named list with
elements:</p><ul><li><p>log:</p><ul><li><p>a log of (rough) timings and other information from the process</p></li>
</ul></li>
<li><p>abandoned:</p><ul><li><p>Logical indicating if the sdm was abandoned. If abandoned is TRUE, some
list elements may not be present</p></li>
</ul></li>
<li><p>presence_ras:</p><ul><li><p>tibble with two columns ('x' and 'y') representing unique cell
centroids on the predictors at presences supplied in argument <code>presence</code></p></li>
</ul></li>
<li><p>predict_boundary:</p><ul><li><p>sf used to limit the background points and used by <code><a href="predict_sdm.html">predict_sdm()</a></code> to
generate the 'mask'ed output</p></li>
</ul></li>
<li><p>bg_points:</p><ul><li><p>sf of cell centroids representing unique cell centroids for background
points</p></li>
</ul></li>
<li><p>blocks</p><ul><li><p>data.frame with columns:</p><ul><li><p><code>pa</code>: presence (1) or absence/background (0)</p></li>
<li><p><code>x</code> and <code>y</code>: cell centroids for each presence and absence</p></li>
<li><p><code>block</code>: the spatial block to which the row belongs</p></li>
<li><p>a column with values for each of <code>predictors</code> at <code>x</code> and <code>y</code></p></li>
</ul></li>
</ul></li>
<li><p>spatial_folds_used:</p><ul><li><p>logical indicating if spatial folds were used. This may differ from
the <code>spatial_folds</code> argument provided to <code>prep_sdm()</code> if an attempt to
use spatial folds failed to meet desired <code>folds</code> and <code>min_fold_n</code></p></li>
</ul></li>
<li><p>correlated:</p><ul><li><p>list with elements as per <code><a href="https://acanthiza.github.io/envModel/reference/reduce_env.html" class="external-link">envModel::reduce_env()</a></code>, or, if
<code>reduce_env</code> is <code>FALSE</code>, a list with elements <code>remove_env</code> which is
empty, and <code>env_var</code>, containing the names of all predictors.</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Options for managing memory are <code>terra_options</code>, <code>max_cells_in_memory</code> and
<code>do_gc</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">out_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"envSDM"</span><span class="op">)</span>, <span class="st">"examples"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"predicts"</span><span class="op">)</span>, <span class="st">"ex"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span>regexp <span class="op">=</span> <span class="st">"\\.csv$"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">enframe</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, value <span class="op">=</span> <span class="st">"path"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>taxa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\.csv"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>                  , presence <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">path</span>, <span class="fu">rio</span><span class="fu">::</span><span class="va"><a href="http://gesistsa.github.io/rio/reference/import.html" class="external-link">import</a></span>, setclass <span class="op">=</span> <span class="st">"tibble"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                  , presence <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">presence</span></span></span>
<span class="r-in"><span>                                          , \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>                                            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span></span></span>
<span class="r-in"><span>                                                          , <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lon</span><span class="op">)</span></span></span>
<span class="r-in"><span>                                                          <span class="op">)</span></span></span>
<span class="r-in"><span>                                          <span class="op">)</span></span></span>
<span class="r-in"><span>                  , taxa_dir <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="va">taxa</span><span class="op">)</span></span></span>
<span class="r-in"><span>                  , out_mcp <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">taxa_dir</span>, <span class="st">"mcp.parquet"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">env_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ex/bio.tif"</span>, package <span class="op">=</span> <span class="st">"predicts"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># mcps --------</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># make a clip boundary so mcps stay terrestrial</span></span></span>
<span class="r-in"><span>  <span class="va">clip</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.polygons.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">env_dat</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pwalk</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">presence</span></span></span>
<span class="r-in"><span>                   , <span class="va">data</span><span class="op">$</span><span class="va">out_mcp</span></span></span>
<span class="r-in"><span>                   <span class="op">)</span></span></span>
<span class="r-in"><span>              , \<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="make_mcp.html">make_mcp</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, pres_x <span class="op">=</span> <span class="st">"lon"</span></span></span>
<span class="r-in"><span>                                 , clip <span class="op">=</span> <span class="va">clip</span></span></span>
<span class="r-in"><span>                                 <span class="op">)</span></span></span>
<span class="r-in"><span>              <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># prep -----------</span></span></span>
<span class="r-in"><span>  <span class="co"># use the just created mcps (this allows using, say, a different spatial reliability threshold for the mcps)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pwalk</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">taxa</span></span></span>
<span class="r-in"><span>                    , <span class="va">data</span><span class="op">$</span><span class="va">taxa_dir</span></span></span>
<span class="r-in"><span>                    , <span class="va">data</span><span class="op">$</span><span class="va">presence</span></span></span>
<span class="r-in"><span>                    , <span class="va">data</span><span class="op">$</span><span class="va">out_mcp</span></span></span>
<span class="r-in"><span>                    <span class="op">)</span></span></span>
<span class="r-in"><span>               , <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">d</span><span class="op">)</span> <span class="fu">prep_sdm</span><span class="op">(</span>this_taxa <span class="op">=</span> <span class="va">a</span></span></span>
<span class="r-in"><span>                                               , out_dir <span class="op">=</span> <span class="va">b</span></span></span>
<span class="r-in"><span>                                               , presence <span class="op">=</span> <span class="va">c</span></span></span>
<span class="r-in"><span>                                               , pres_x <span class="op">=</span> <span class="st">"lon"</span></span></span>
<span class="r-in"><span>                                               , pres_y <span class="op">=</span> <span class="st">"lat"</span></span></span>
<span class="r-in"><span>                                               , predictors <span class="op">=</span> <span class="va">env_dat</span></span></span>
<span class="r-in"><span>                                               , is_env_pred <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span>                                               , pred_limit <span class="op">=</span> <span class="va">d</span></span></span>
<span class="r-in"><span>                                               , limit_buffer <span class="op">=</span> <span class="fl">10000</span></span></span>
<span class="r-in"><span>                                               , dens_res <span class="op">=</span> <span class="fl">1000</span> <span class="co"># ignored as decimal degrees preds</span></span></span>
<span class="r-in"><span>                                               , force_new <span class="op">=</span> <span class="cn">T</span></span></span>
<span class="r-in"><span>                                               <span class="op">)</span></span></span>
<span class="r-in"><span>               <span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Missing `trust` will be set to FALSE by default for RDS in 2.0.0.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> prep for acaule</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> out_dir is H:/temp/nige/Rtmp2hSWI8/temp_libpath29784aed27b3/envSDM/examples/acaule</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Joining with `by = join_by(x, y)`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   4%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  24%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fold 5 has class(es) with zero records</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Joining with `by = join_by(fold_ids)`</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Missing `trust` will be set to FALSE by default for RDS in 2.0.0.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> prep for bradypus</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> out_dir is H:/temp/nige/Rtmp2hSWI8/temp_libpath29784aed27b3/envSDM/examples/bradypus</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Joining with `by = join_by(x, y)`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   4%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  24%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># example of 'prep'</span></span></span>
<span class="r-in"><span>  <span class="va">prep</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="http://gesistsa.github.io/rio/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">taxa_dir</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="st">"prep.rds"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Missing `trust` will be set to FALSE by default for RDS in 2.0.0.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prep</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "abandoned"          "finished"           "this_taxa"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [4] "presence_ras"       "predict_boundary"   "bg_points"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [7] "blocks"             "spatial_folds_used" "reduce_env"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [10] "log"                "original"          </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># env variables to remove prior to SDM</span></span></span>
<span class="r-in"><span>  <span class="va">prep</span><span class="op">$</span><span class="va">reduce_env</span><span class="op">$</span><span class="va">remove</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "bio1"  "bio9"  "block" "cell"  "lat"   "lon"   "pa"    "x"     "y"    </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Density raster</span></span></span>
<span class="r-in"><span>  <span class="va">dens_ras</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">taxa_dir</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="st">"density.tif"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">clip</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="kw">if</span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://r-tmap.github.io/tmap/" class="external-link">"tmap"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="va">m</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">clip</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">dens_ras</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_raster.html" class="external-link">tm_raster</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Background point density"</span></span></span>
<span class="r-in"><span>                , breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span>                , drop.levels <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>                , colorNA <span class="op">=</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span>                <span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_legend</a></span><span class="op">(</span>outside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_compass.html" class="external-link">tm_compass</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_scale_bar.html" class="external-link">tm_scale_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>main.title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Background point density for "</span>,  <span class="va">prep</span><span class="op">$</span><span class="va">this_taxa</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="va">m</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="va">presences</span> <span class="op">&lt;-</span> <span class="va">prep</span><span class="op">$</span><span class="va">blocks</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pa</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                   , crs <span class="op">=</span> <span class="fl">4326</span></span></span>
<span class="r-in"><span>                   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="va">m</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">presences</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: tmap</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Breaking News: tmap 3.x is retiring. Please test v4, e.g. with</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> remotes::install_github('r-tmap/tmap')</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Scale bar set for latitude km and will be different at the top and bottom of the map.</span>
<span class="r-plt img"><img src="prep_sdm-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Background points</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://r-tmap.github.io/tmap/" class="external-link">"tmap"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">prep</span><span class="op">$</span><span class="va">blocks</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">block</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span> <span class="co"># for map</span></span></span>
<span class="r-in"><span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                   , crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">env_dat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>                   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">clip</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Background points\n coloured by block"</span></span></span>
<span class="r-in"><span>              , col <span class="op">=</span> <span class="st">"block"</span></span></span>
<span class="r-in"><span>              <span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_legend</a></span><span class="op">(</span>outside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_compass.html" class="external-link">tm_compass</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_scale_bar.html" class="external-link">tm_scale_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>main.title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Background points for "</span>,  <span class="va">prep</span><span class="op">$</span><span class="va">this_taxa</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Scale bar set for latitude km and will be different at the top and bottom of the map.</span>
<span class="r-plt img"><img src="prep_sdm-2.png" alt="" width="700" height="433"></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stuart Brown, Nigel Willoughby, Joel Allan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

